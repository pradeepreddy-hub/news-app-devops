name: News App CI/CD

on:
  push:
    branches: [ feature-1 ]
  pull_request:

env:
  TOMCAT_VERSION: "10.1.49"
  TOMCAT_DIR: "/opt/tomcat10"
  TOMCAT_DOWNLOAD_URL: "https://archive.apache.org/dist/tomcat/tomcat-10/v${{ env.TOMCAT_VERSION }}/bin/apache-tomcat-${{ env.TOMCAT_VERSION }}.tar.gz"
  TOMCAT_WEBAPPS: "/opt/tomcat10/webapps"
  WAR_NAME: "news-app.war"
  APP_CONTEXT: "news-app"
  TOMCAT_HOST: "3.110.107.91"     # change to your host or make it a secret
  TOMCAT_PORT: "8080"

jobs:
  build-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'maven'    # automatically caches ~/.m2

      - name: Verify Java & Maven (runtime info)
        run: |
          java -version
          mvn -version || true

      - name: Cache Maven local repository (explicit backup)
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Ensure Tomcat 10 installed
        run: |
          set -e
          if [ -d "${TOMCAT_DIR}" ]; then
            echo "Tomcat already installed at ${TOMCAT_DIR}"
            ${TOMCAT_DIR}/bin/version.sh || true
          else
            echo "Installing Tomcat ${TOMCAT_VERSION}..."
            sudo mkdir -p /opt
            cd /opt
            sudo wget "${TOMCAT_DOWNLOAD_URL}"
            sudo tar -xzf "apache-tomcat-${TOMCAT_VERSION}.tar.gz"
            sudo mv "apache-tomcat-${TOMCAT_VERSION}" "${TOMCAT_DIR}"
            sudo chmod +x "${TOMCAT_DIR}/bin/"*.sh
            echo "Tomcat installed to ${TOMCAT_DIR}"
          fi

      - name: Run Unit Tests
        run: |
          set -e
          echo "Running mvn test"
          mvn -B -V test

      - name: Build WAR File
        run: |
          set -e
          echo "Packaging application (WAR)"
          mvn -B -V clean package

      - name: Stop Tomcat (if running)
        run: |
          set -e
          echo "Stopping Tomcat (if running)..."
          sudo "${TOMCAT_DIR}/bin/shutdown.sh" || true
          sleep 3

      - name: Clean old deployment and copy new WAR
        run: |
          set -e
          echo "Removing old deployment artifacts..."
          sudo rm -rf "${TOMCAT_WEBAPPS}/${APP_CONTEXT}" || true
          sudo rm -f "${TOMCAT_WEBAPPS}/${WAR_NAME}" || true

          echo "Copying new WAR to ${TOMCAT_WEBAPPS}..."
          sudo cp "target/${WAR_NAME}" "${TOMCAT_WEBAPPS}/"
          ls -l "${TOMCAT_WEBAPPS}/"

      - name: Start Tomcat
        run: |
          set -e
          echo "Starting Tomcat..."
          sudo "${TOMCAT_DIR}/bin/startup.sh"
          # give Tomcat time to boot
          sleep 8

      - name: Health check (retry)
        run: |
          set -e
          URL="http://${TOMCAT_HOST}:${TOMCAT_PORT}/${APP_CONTEXT}/"
          echo "Checking ${URL}"
          attempts=0
          max_attempts=12
          until curl -sSf -I "${URL}" >/dev/null 2>&1 || [ $attempts -ge $max_attempts ]; do
            attempts=$((attempts+1))
            echo "Attempt ${attempts}/${max_attempts} â€” waiting 5s..."
            sleep 5
          done

          if [ $attempts -ge $max_attempts ]; then
            echo "Health check failed after ${max_attempts} attempts"
            exit 1
          fi

          echo "Health check passed"

      - name: Verify app content
        run: |
          set -e
          URL="http://${TOMCAT_HOST}:${TOMCAT_PORT}/${APP_CONTEXT}/"
          echo "Fetching ${URL}"
          RESPONSE=$(curl -sS "${URL}")
          echo "---- Response snippet ----"
          echo "${RESPONSE}" | sed -n '1,120p'
          echo "---- Assertions ----"
          echo "${RESPONSE}" | grep -q "Welcome to news App" && echo "Found welcome message" || (echo "Missing 'Welcome to news App'" && false)
          echo "${RESPONSE}" | grep -q "Live News Categories" && echo "Found categories" || (echo "Missing 'Live News Categories'" && false)
          echo "${RESPONSE}" | grep -q "Top Headlines" && echo "Found headlines" || (echo "Missing 'Top Headlines'" && false)

      # Optional: stop Tomcat after verification (if you want the app to remain up, remove this step)
      - name: Stop Tomcat (cleanup)
        if: always()
        run: |
          echo "Stopping Tomcat (cleanup step)..."
          sudo "${TOMCAT_DIR}/bin/shutdown.sh" || true
